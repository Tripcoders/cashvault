
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- USER & AUTHENTICATION ---

enum UserRole {
  USER
  ADMIN
  SUPPORT
}

enum UserTier {
  Basic
  Premium
  VIP
}

model User {
  id            String    @id // Maps to Stack Auth ID
  email         String    @unique
  username      String?
  avatar        String?
  role          UserRole  @default(USER)
  tier          UserTier  @default(Basic)
  
  // Financials
  balance       Float     @default(0.0) // Cached balance (for speed)
  currency      String    @default("USD")
  
  // Activity
  isBanned      Boolean   @default(false)
  lastLoginAt   DateTime?
  lastLoginIp   String?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  orders        Order[]
  transactions  Transaction[]
  tickets       Ticket[]
  loginHistory  LoginHistory[]
  reviews       Review[]
}

model LoginHistory {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  ip        String?
  userAgent String?
  location  String?  // e.g., "New York, US"
  createdAt DateTime @default(now())
}

// --- FINANCIAL LEDGER (The Bank) ---

enum TransactionType {
  DEPOSIT
  PURCHASE
  REFUND
  WITHDRAWAL
  ADJUSTMENT
  BONUS
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

model Transaction {
  id              String            @id @default(cuid())
  userId          String
  user            User              @relation(fields: [userId], references: [id])
  
  amount          Float             // Positive for deposit, negative for spend
  type            TransactionType
  status          TransactionStatus @default(PENDING)
  
  description     String?
  referenceId     String?           // External ID (e.g., Crypto TxHash)
  balanceSnapshot Float             // Balance AFTER this transaction (for integrity checks)
  
  metadata        Json?             // Flexible data (e.g., crypto network, tax info)
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([userId])
  @@index([type])
}

// --- COMMERCE & INVENTORY ---

model Product {
  id          String      @id @default(cuid())
  title       String
  description String
  price       Float
  category    String      // Could be an Enum or Relation for tighter control
  grade       String?     // "High", "Medium", "Low"
  
  // Inventory
  stock       Int         @default(0)
  isDigital   Boolean     @default(true)
  autoDeliveryData String? // Secret data sent immediately upon purchase
  
  image       String
  features    String[]
  
  views       Int         @default(0)
  salesCount  Int         @default(0)

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  orderItems  OrderItem[]
  reviews     Review[]
}

model Review {
  id        String   @id @default(cuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  rating    Int      // 1-5
  comment   String?
  
  createdAt DateTime @default(now())
}

// --- ORDER MANAGEMENT ---

enum OrderStatus {
  PENDING
  COMPLETED
  CANCELLED
  REFUNDED
  DISPUTED
}

model Order {
  id            String      @id @default(cuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id])
  
  total         Float
  status        OrderStatus @default(COMPLETED)
  
  // Snapshot data (in case User/Product changes later)
  snapshot      Json?
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  items         OrderItem[]
  ticket        Ticket?     // If there is a dispute linked to this order
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id])
  productId String
  product   Product @relation(fields: [productId], references: [id])
  
  quantity  Int     @default(1)
  price     Float   // Price frozen at time of purchase
}

// --- CUSTOMER SUPPORT ---

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Ticket {
  id        String         @id @default(cuid())
  userId    String
  user      User           @relation(fields: [userId], references: [id])
  orderId   String?        @unique // Optional link to specific order
  order     Order?         @relation(fields: [orderId], references: [id])
  
  subject   String
  status    TicketStatus   @default(OPEN)
  priority  TicketPriority @default(MEDIUM)
  
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  
  messages  TicketMessage[]
}

model TicketMessage {
  id        String   @id @default(cuid())
  ticketId  String
  ticket    Ticket   @relation(fields: [ticketId], references: [id])
  
  senderId  String   // User ID or Staff ID
  content   String
  isAdmin   Boolean  @default(false) // True if sent by support staff
  
  createdAt DateTime @default(now())
}