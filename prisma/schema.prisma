generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id               String         @id
  email            String         @unique
  username         String?
  avatar           String?
  role             UserRole       @default(USER)
  tier             UserTier       @default(Basic)
  balance          Float          @default(0.0)
  currency         String         @default("USD")
  isBanned         Boolean        @default(false)
  isEmailVerified  Boolean        @default(false)
  emailOtpCode     String?
  emailOtpExpires  DateTime?
  lastLoginAt      DateTime?
  lastLoginIp      String?
  lastActivityAt   DateTime       @default(now())
  accountCreatedAt DateTime       @default(now())
  accountExpiresAt DateTime?
  hasMadeDeposit   Boolean        @default(false)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  cryptoWallets    CryptoWallet[]
  loginHistory     LoginHistory[]
  orders           Order[]
  reviews          Review[]
  tickets          Ticket[]
  transactions     Transaction[]
}

model LoginHistory {
  id        String   @id @default(cuid())
  userId    String
  ip        String?
  userAgent String?
  location  String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model CryptoWallet {
  id        String    @id @default(cuid())
  userId    String
  currency  String
  address   String
  network   String?
  createdAt DateTime  @default(now())
  expiresAt DateTime?
  user      User      @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Transaction {
  id              String            @id @default(cuid())
  userId          String
  amount          Float
  type            TransactionType
  status          TransactionStatus @default(PENDING)
  cryptoCurrency  CryptoCurrency?
  cryptoAmount    Float?
  cryptoAddress   String?
  txHash          String?
  description     String?
  referenceId     String?
  balanceSnapshot Float
  metadata        Json?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  user            User              @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([type])
}

model Product {
  id               String          @id @default(cuid())
  title            String
  description      String
  price            Float
  category         ProductCategory
  grade            String?
  bankName         String?
  bankBalance      Float?
  bankCountry      String?
  cardType         String?
  cardLimit        Float?
  paypalBalance    Float?
  paypalAge        Int?
  otpProvider      String?
  otpType          String?
  ratFeatures      String[]
  stock            Int             @default(0)
  isDigital        Boolean         @default(true)
  autoDeliveryData String?
  image            String
  features         String[]
  views            Int             @default(0)
  salesCount       Int             @default(0)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  orderItems       OrderItem[]
  reviews          Review[]
}

model Review {
  id        String   @id @default(cuid())
  productId String
  userId    String
  rating    Int
  comment   String?
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
}

model Order {
  id        String      @id @default(cuid())
  userId    String
  total     Float
  status    OrderStatus @default(COMPLETED)
  snapshot  Json?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  user      User        @relation(fields: [userId], references: [id])
  items     OrderItem[]
  ticket    Ticket?
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  productId String
  quantity  Int     @default(1)
  price     Float
  order     Order   @relation(fields: [orderId], references: [id])
  product   Product @relation(fields: [productId], references: [id])
}

model Ticket {
  id        String          @id @default(cuid())
  userId    String
  orderId   String?         @unique
  subject   String
  status    TicketStatus    @default(OPEN)
  priority  TicketPriority  @default(MEDIUM)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  order     Order?          @relation(fields: [orderId], references: [id])
  user      User            @relation(fields: [userId], references: [id])
  messages  TicketMessage[]
}

model TicketMessage {
  id        String   @id @default(cuid())
  ticketId  String
  senderId  String
  content   String
  isAdmin   Boolean  @default(false)
  createdAt DateTime @default(now())
  ticket    Ticket   @relation(fields: [ticketId], references: [id])
}

enum UserRole {
  USER
  ADMIN
  SUPPORT
}

enum UserTier {
  Basic
  Premium
  VIP
}

enum TransactionType {
  DEPOSIT
  PURCHASE
  REFUND
  WITHDRAWAL
  ADJUSTMENT
  BONUS
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

enum CryptoCurrency {
  BTC
  LTC
  USDT
  SOL
}

enum ProductCategory {
  BANK_LOGS
  OFFICE_365
  CASH_OUT
  OTP_BOT
  CC_TOPUP
  RAT
  RDP
  PAYPAL
}

enum OrderStatus {
  PENDING
  COMPLETED
  CANCELLED
  REFUNDED
  DISPUTED
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}
